<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snow Globe â€” For You</title>
  <style>
    :root{ --msgScale: 1; }

    html, body{
      height:100%;
      margin:0;
      background:#3056b6;
      overflow:hidden;
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    #stage{ position:fixed; inset:0; z-index:0; }
    canvas{ display:block; }

    #ui{
      position:fixed;
      top:16px;
      left:16px;
      z-index:10;
      display:flex;
      gap:8px;
    }
    #ui button{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      background:rgba(0,0,0,.35);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      backdrop-filter:blur(4px);
      -webkit-backdrop-filter:blur(4px);
      font-size:14px;
    }
    #ui button:hover{ background:rgb(56, 84, 144); }

    /* å·¦ä¾§ 1/4 æ ï¼šé»˜è®¤å°½é‡â€œä¸€å±æ˜¾ç¤ºâ€ï¼Œå¦‚æœå®åœ¨å¡ä¸ä¸‹ä»å¯æ»šè½®æ»šåŠ¨ï¼Œä½†æ»šåŠ¨æ¡éšè— */
    #messageLayer{
      position:fixed;
      top:0; left:0;
      width:25vw;
      height:100vh;
      padding:72px 12px 12px;
      z-index:6;
      box-sizing:border-box;

      overflow-y:auto;      /* å…è®¸æ»šè½®ï¼Œä½†â€¦ */
      overflow-x:hidden;
      scrollbar-width:none; /* Firefox éšè—æ»šåŠ¨æ¡ */
      -ms-overflow-style:none; /* æ—§ Edge/IE */
      pointer-events:auto;

      transform-origin:top left;
      transform:scale(var(--msgScale));
    }
    #messageLayer::-webkit-scrollbar{ width:0; height:0; } /* Chrome/Safari éšè—æ»šåŠ¨æ¡ */

    .msgItem{
      display:block;
      max-width:100%;
      padding:3px 8px;
      margin:3px 0;
      border-radius:14px;

      font-size:12px;
      line-height:1.25;
      letter-spacing:0.2px;
      color:rgba(255,255,255,0.92);
      text-align:left;

      white-space:pre-wrap; /* âœ… å…³é”®ï¼šä¿ç•™æ®µå†…æ¢è¡Œï¼ˆæ›´åƒä¸€æ®µå¯„è¯­ï¼‰ï¼Œä¸å†æ‹†æˆä¸€å †çŸ­æ¡ */
      user-select:none;

      backdrop-filter:blur(2px);
      -webkit-backdrop-filter:blur(2px);
      text-shadow:0 2px 10px rgba(0,0,0,0.16), 0 0 12px rgba(255,255,255,0.10);
      box-shadow:0 0 0 1px rgba(255,255,255,0.05) inset, 0 0 14px rgba(255,255,255,0.05);
      background:rgba(255,255,255,0.08);
    }

    /* é¼ æ ‡é›ªèŠ±æ‹–å°¾å±‚ */
    #mouseTrailLayer{
      position:fixed;
      inset:0;
      z-index:8;
      pointer-events:none;
      overflow:hidden;
    }
    .trailDot{
      position:absolute;
      width:6px;
      height:6px;
      border-radius:50%;
      background:rgba(255,255,255,0.95);
      box-shadow:0 0 8px rgba(255,255,255,0.9);
      pointer-events:none;
      animation:trailFade .85s ease-out forwards;
    }
    @keyframes trailFade{
      0%{ transform:translate(0,0) scale(1); opacity:1; }
      100%{ transform:translate(0,12px) scale(0.05); opacity:0; }
    }

    /* ç‚¹å‡»æ¨¡å‹å¼¹å‡ºçš„ç”»ï¼ˆä¿ç•™ï¼šä½ ç°åœ¨æ²¡æè¦å»æ‰å®ƒï¼‰ */
    #artOverlay{
      position:fixed;
      inset:0;
      z-index:9;
      display:none;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at center, rgba(0,0,0,0.18), rgba(0,0,0,0.70));
    }
    .artBox{
      max-width:70vw;
      max-height:80vh;
      padding:8px;
      border-radius:18px;
      background:rgba(0,0,0,0.65);
      box-shadow:0 18px 60px rgba(0,0,0,0.75);
      overflow:hidden;
    }
    #artImage{ display:block; max-width:100%; max-height:100%; }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="stage"></div>
  <div id="messageLayer"></div>
  <div id="mouseTrailLayer"></div>

  <div id="artOverlay">
    <div class="artBox">
      <img id="artImage" src="./art.png" alt="Artwork" />
    </div>
  </div>

  <div id="ui">
    <button id="musicBtn">ğŸµ æ’­æ”¾éŸ³ä¹</button>
    <button id="snowBtn">â„ï¸ å¼€å¯ä¸‹é›ª</button>
    <button id="spinBtn">ğŸ”„ è‡ªåŠ¨æ—‹è½¬</button>
  </div>

  <audio id="bgm" src="./music.mp3" loop preload="auto"></audio>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    

    const stage = document.getElementById('stage');
    const renderer = new THREE.WebGLRenderer({ antialias:false, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene();

// å…ˆç»™ä¸€ä¸ªé»˜è®¤è“è‰²ï¼Œé˜²æ­¢è´´å›¾è¿˜æ²¡åŠ è½½å¥½æ—¶æ˜¯é»‘å±
scene.background = new THREE.Color(0x5484FF);

// åŠ è½½ä½ è‡ªå·±çš„ 2:1 å…¨æ™¯å›¾ï¼ˆæ–‡ä»¶åæ”¹æˆä½ å®é™…çš„ï¼Œæ¯”å¦‚ env.jpgï¼‰
// ç¡®ä¿ env.jpg å’Œ index.html åœ¨åŒä¸€æ–‡ä»¶å¤¹
const texLoader = new THREE.TextureLoader();
texLoader.load('./env.jpg', (tex) => {
  // å‘Šè¯‰ threeï¼šè¿™æ˜¯ equirectangular å…¨æ™¯
  tex.mapping = THREE.EquirectangularReflectionMapping;
  tex.colorSpace = THREE.SRGBColorSpace;

  // åŒæ—¶ä½œä¸ºèƒŒæ™¯å’Œç¯å¢ƒè´´å›¾
  scene.background  = tex;
  scene.environment = tex;
}, undefined, (error) => {
  console.error('env.jpg åŠ è½½å¤±è´¥ï¼š', error);
});

// â†“ ä»è¿™é‡Œå¼€å§‹æ˜¯åŸæ¥çš„ç›¸æœº / æ§åˆ¶å™¨ / ç¯å…‰ï¼Œä¿æŒä¸å˜
const camera = new THREE.PerspectiveCamera(
  45,
  window.innerWidth / window.innerHeight,
  0.01,
  100
);
camera.position.set(0, 1.2, 3.2);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff, 1.0));


    const loader = new GLTFLoader();
    let model = null;

    loader.load('./model.glb', (gltf)=>{
      model = gltf.scene;
      scene.add(model);

      model.traverse(obj=>{
        if(!obj.isMesh) return;
        const n = (obj.name || '').toLowerCase();
        const mn = (obj.material?.name || '').toLowerCase();
        if(n.includes('sphere') || n.includes('globe') || n.includes('çƒ') || mn.includes('glass') || mn.includes('çƒ')){
          obj.material = new THREE.MeshPhysicalMaterial({
            color:0xffffff,
            metalness:0,
            roughness:0.02,
            transmission:0.0,
            thickness:0.1,
            ior:1.0,
            transparent:true,
            opacity:0.22,
            envMapIntensity:0.1,
            clearcoat:1.0,
            clearcoatRoughness:0.12,
            side:THREE.DoubleSide
          });
        }
      });

      const box = new THREE.Box3().setFromObject(model);
      const center = box.getCenter(new THREE.Vector3());
      model.position.sub(center);

      controls.target.set(0,0.9,0);
      controls.update();
    }, undefined, err=>{
      console.error('GLB load error:', err);
    });

    // ===== é›ªèŠ±ç‚¹äº‘ =====
    const snowCount = 2000;
    const snowGeo = new THREE.BufferGeometry();
    const snowPos = new Float32Array(snowCount * 3);
    for(let i=0;i<snowCount;i++){
      snowPos[i*3+0] = (Math.random()-0.5)*6;
      snowPos[i*3+1] = Math.random()*4;
      snowPos[i*3+2] = (Math.random()-0.5)*6;
    }
    snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos,3));
    const snowMat = new THREE.PointsMaterial({
      color:0xffffff,
      size:3,
      sizeAttenuation:false,
      transparent:true,
      opacity:0.95,
      depthWrite:false
    });
    const snow = new THREE.Points(snowGeo, snowMat);
    let snowOn = true;
    snow.visible = snowOn;
    scene.add(snow);

    function updateSnow(){
      const pos = snowGeo.attributes.position.array;
      for(let i=0;i<snowCount;i++){
        pos[i*3+1] -= 0.015 + Math.random()*0.1;
        pos[i*3+0] += (Math.random()-0.5)*0.4;
        pos[i*3+2] += (Math.random()-0.5)*0.5;
        if(pos[i*3+1] < -0.2) pos[i*3+1] = Math.random()*4 + 0.8;
      }
      snowGeo.attributes.position.needsUpdate = true;
    }

    // ===== UIï¼šéŸ³ä¹/ä¸‹é›ª/æ—‹è½¬ =====
    const bgm = document.getElementById('bgm');
    const musicBtn = document.getElementById('musicBtn');
    const snowBtn = document.getElementById('snowBtn');
    const spinBtn = document.getElementById('spinBtn');

    let musicOn = false;
    musicBtn.addEventListener('click', async ()=>{
      try{
        if(!musicOn){
          await bgm.play();
          musicOn = true;
          musicBtn.textContent = 'â¸ æš‚åœéŸ³ä¹';
        }else{
          bgm.pause();
          musicOn = false;
          musicBtn.textContent = 'ğŸµ æ’­æ”¾éŸ³ä¹';
        }
      }catch(e){
        console.warn('Play failed:', e);
      }
    });

    snowBtn.addEventListener('click', ()=>{
      snowOn = !snowOn;
      snow.visible = snowOn;
      snowBtn.textContent = snowOn ? 'â„ï¸ å…³é—­ä¸‹é›ª' : 'â„ï¸ å¼€å¯ä¸‹é›ª';
    });

    let spinOn = true;
    spinBtn.addEventListener('click', ()=>{
      spinOn = !spinOn;
      spinBtn.textContent = spinOn ? 'â¹ åœæ­¢æ—‹è½¬' : 'ğŸ”„ è‡ªåŠ¨æ—‹è½¬';
    });

    snowBtn.textContent = snowOn ? 'â„ï¸ å…³é—­ä¸‹é›ª' : 'â„ï¸ å¼€å¯ä¸‹é›ª';
    spinBtn.textContent = spinOn ? 'â¹ åœæ­¢æ—‹è½¬' : 'ğŸ”„ è‡ªåŠ¨æ—‹è½¬';

    async function tryAutoPlay(){
      try{
        await bgm.play();
        musicOn = true;
        musicBtn.textContent = 'â¸ æš‚åœéŸ³ä¹';
      }catch(e){
        console.warn('Autoplay blocked; will retry on first user interaction.');
      }
    }
    tryAutoPlay();
    window.addEventListener('pointerdown', ()=>{ if(!musicOn) tryAutoPlay(); }, { once:true });

    // ===== ç”Ÿæ—¥æ–‡æ¡ˆï¼ˆåŸæ–‡ä¸å˜ï¼‰=====
    const birthText = `
ç”Ÿæ—¥å¿«ä¹ï¼
Dearè€éŸ©ï¼š
22å²ç”Ÿæ—¥å¿«ä¹å•Šï¼
çœ‹ï¼Œæˆ‘çš„æŠ€æœ¯åˆè¿›æ­¥äº†ï¼ˆç¬‘ï¼‰
å»å¹´æ˜¯æ¸¸æˆï¼Œä»Šå¹´æ²¡æœ‰èƒ½åŠ›ä¸ç²¾åŠ›å»åšã€Šä¸‰äººè¡Œ2.0ã€‹äº†ï¼Œæ¯•ç«Ÿå†™å‰§æƒ…ï¼Œæƒ³æ–‡æ¡ˆï¼Œæ­åœºæ™¯ï¼Œå®Œå–„é€»è¾‘çœŸçš„å¾ˆä»¤äººå¤´å¤§ã€‚æ‰€ä»¥åšäº†è¿™ä¸ªï¼Œå¸Œæœ›ä½ èƒ½å¤Ÿå–œæ¬¢ã€‚
ä¸è¿‡æ¯ä¸€å¹´çš„ç”Ÿæ—¥ç¤¼ç‰©éƒ½ä¸ä¸€æ ·ï¼Œç›¸ä¿¡ä½ æ‰“å¼€è¿™ä¸ªé“¾æ¥æ—¶è¿˜æ˜¯ç¨ç¨åƒäº†ä¸€æƒŠçš„ï¼Œå¯¹å§ï¼Ÿ
å…¶å®å¤§éƒ¨åˆ†åŠŸåŠ³éƒ½å¤šäºäº²çˆ±çš„Gè€å¸ˆçš„å¸®åŠ©ï¼Œæˆ‘ä¸»è¦åŠ¨è„‘å­å’Œå¤åˆ¶ç²˜è´´ï¼ˆåè¡€ï¼‰
å®Œæˆæ­å»ºçš„è¿™ä¸€å¤©æ°å¥½æ˜¯å¹³å®‰å¤œï¼Œç­‰ä½ æ‹†å¼€è¿™ä»½ç¤¼ç‰©æ—¶ï¼Œä¹Ÿä»æ²‰æµ¸åœ¨åœ£è¯çš„ä½™æ¸©ä¸­å§ï¼Œæ‰€ä»¥æˆ‘é€‰äº†è¿™ä¸€é¦–èƒŒæ™¯éŸ³ä¹ï¼Œè¿˜æŒºåº”æ™¯çš„(â€¾â—¡â—)
è¿™ä¸ªæ¨¡å‹å®Œæˆæ—¶å·®ä¸å¤šæœ‰ä¸¤ä¸ªGï¼Œå“æ­»æˆ‘äº†ã€‚ç›´æ¥æŠŠæˆ‘çš„blenderå¹²å´©æºƒäº†ã€‚ä¸ºäº†ç²¾ç®€ç¤¼ç‰©ï¼Œæˆ‘æŠŠæ¨¡å‹åšäº†ç®€åŒ–å¤„ç†ï¼Œæ‰ç»ˆäºè®©æˆ‘çš„blenderæ¢å¤ã€‚æ‰€ä»¥ç°åœ¨çš„æ¨¡å‹çœ‹èµ·æ¥ä¼šæ¯”è¾ƒæ¨¡ç³Šã€‚
å¯¹å•¦ï¼Œæ»šåŠ¨é¼ æ ‡ä¸­é”®å¯ä»¥æ”¾å¤§å’Œç¼©å°æ¨¡å‹ï¼Œæ‹–åŠ¨å±å¹•è¿˜å¯ä»¥360Â°æŸ¥çœ‹æ¨¡å‹ã€‚ç‚¹å‡»æ¨¡å‹è¿˜ä¼šæœ‰å°æƒŠå–œå™¢ï¼

ä¸çŸ¥ä¸è§‰é—´åˆåˆ°å¹´åº•äº†ï¼Œã€Šæ­å–œä½ ã€‹ä¹Ÿå·®ä¸å¤šè¯¥è§£å†»äº†å§ï¼Ÿæˆ‘ä»¬çš„å¤§å­¦ç”Ÿæ´»ä¹Ÿå¿«åˆ°å°¾å£°äº†ã€‚ä¸‹ä¸€æ­¥è¯¥å¾€å“ªèµ°ï¼Œæˆ–è®¸ä½ ä»åœ¨è¸Œèº‡ï¼Œæˆ–è®¸ä½ å·²ç»ä¸‹å®šå†³å¿ƒå‡†å¤‡å¯èˆªï¼Œæ— è®ºå¦‚ä½•ï¼Œå¹´å¹´å²å²åˆä¸€å¹´ï¼Œä»Šå¹´å’Œæ˜å¹´ä¹Ÿè¦å¹³å®‰é¡ºé‚å•Šã€‚
å¸Œæœ›æ˜å¹´ï¼Œæˆ‘ä»¬ä»æœ‰æœºä¼šä¸€èµ·æ²¿ç€æ²³å ¤è¡—æ•£æ­¥ï¼Œä»è·¯çš„è¿™å¤´èµ°åˆ°è·¯çš„é‚£å¤´ï¼›ä¸€èµ·åœ¨ç©ºæ— ä¸€äººçš„å°é“ä¸Šç•…èŠï¼Œæœ›å¤©ï¼Œèº²è·¯ä¸Šçš„è™«å­ä¸æ¸¸çƒŸã€‚

`;

    const messageLayer = document.getElementById('messageLayer');

    // âœ… æ–°ç­–ç•¥ï¼šæŒ‰â€œæ®µè½â€æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯æ‹†æˆå¾ˆå¤šçŸ­æ¡
    // è¿™æ ·å‚ç›´ç©ºé—´æ›´çœï¼Œæœ€åé‚£ä¸€å¤§æ®µä¹Ÿä¸å®¹æ˜“è¢«æŒ¤æ‰ã€‚
    function splitToParagraphBlocks(text){
      return text
        .trim()
        .split(/\n\s*\n/)      // æŒ‰ç©ºè¡Œåˆ†æ®µ
        .map(s=>s.trim())
        .filter(Boolean);
    }

    function makeMsgItem(blockText){
      const div = document.createElement('div');
      div.className = 'msgItem';
      div.textContent = blockText; // white-space:pre-wrap ä¼šä¿ç•™æ®µå†…æ¢è¡Œ
      return div;
    }

    const blocks = splitToParagraphBlocks(birthText);
    blocks.forEach(b=>{
      messageLayer.appendChild(makeMsgItem(b));
    });

    // âœ… è‡ªåŠ¨ç¼©æ”¾ï¼šå»æ‰â€œæœ€ä½ 0.55â€çš„é™åˆ¶ï¼Œå¦åˆ™å†…å®¹å¤šæ—¶ä¼šè¢«è£æ‰
    function autoScaleMessages(){
      messageLayer.style.setProperty('--msgScale','1');
      // ç­‰æµè§ˆå™¨å…ˆè®¡ç®—ä¸€æ¬¡å¸ƒå±€
      const h = messageLayer.clientHeight;
      const contentH = messageLayer.scrollHeight;
      if(contentH <= 0) return;
      let scale = Math.min(1, h / contentH);
      // ç»™ä½ ä¸€ä¸ªæ›´ä½çš„ä¸‹é™ï¼Œå®å¯å°ä¸€ç‚¹ä¹Ÿè¦â€œæ˜¾ç¤ºå®Œæ•´â€
      if(scale < 0.30) scale = 0.30;
      messageLayer.style.setProperty('--msgScale', scale.toFixed(3));
    }

    // é¦–æ¬¡æ¸²æŸ“ååš 2 æ¬¡ç¼©æ”¾ï¼ˆé˜²æ­¢å­—ä½“/å¸ƒå±€è¿˜æ²¡ç¨³å®šï¼‰
    requestAnimationFrame(()=>{ autoScaleMessages(); setTimeout(autoScaleMessages, 120); });

    // ===== é¼ æ ‡é›ªèŠ±æ‹–å°¾ =====
    const trailLayer = document.getElementById('mouseTrailLayer');
    let lastTrailTime = 0;
    window.addEventListener('pointermove', e=>{
      const now = performance.now();
      if(now - lastTrailTime < 16) return;
      lastTrailTime = now;

      const dot = document.createElement('div');
      dot.className = 'trailDot';
      dot.style.left = (e.clientX-3) + 'px';
      dot.style.top  = (e.clientY-3) + 'px';
      trailLayer.appendChild(dot);
      setTimeout(()=>dot.remove(), 850);
    });

    // ===== ç‚¹å‡»æ¨¡å‹å¼¹å‡ºç”» =====
    const artOverlay = document.getElementById('artOverlay');
    const artImage   = document.getElementById('artImage');
    let artReady = false;

    if(artImage){
      const checkReady = ()=>{ artReady = artImage.complete && artImage.naturalWidth>0; };
      artImage.addEventListener('load', checkReady);
      artImage.addEventListener('error', ()=>{ artReady=false; });
      checkReady();
    }

    function showArtOverlay(show){
      if(!artOverlay || !artReady) return;
      artOverlay.style.display = show ? 'flex' : 'none';
    }
    if(artOverlay) artOverlay.addEventListener('click', ()=>showArtOverlay(false));

    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    renderer.domElement.addEventListener('pointerdown', e=>{
      if(!model || !artReady) return;
      const rect = renderer.domElement.getBoundingClientRect();
      pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
      pointer.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
      raycaster.setFromCamera(pointer, camera);
      const hits = raycaster.intersectObject(model, true);
      if(hits.length>0) showArtOverlay(true);
    });

    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      autoScaleMessages();
    });

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      if(spinOn && model) model.rotation.y += 0.005;
      if(snowOn) updateSnow();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
